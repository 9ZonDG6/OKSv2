{% extends 'base.html' %}

{% block title %}–û–ö–°{% endblock %}

{% block content %}
<link type="text/css" rel="stylesheet" href="/media/Usersite/WebsiteBuilderOksCss/builder.css">

<div class="content-container">
    <div class="preview-container" id="preview-container">
    </div>

    <div class="controls-container">
        <div class="controls">
            <h2>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –±–ª–æ–∫</h2>

            <label for="new-block-name">–ò–º—è –Ω–æ–≤–æ–≥–æ –±–ª–æ–∫–∞:</label>
            <input type="text" id="new-block-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ë–ª–æ–∫ 2">

            <button id="add-block">–î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫</button>
        </div>

        <hr>

        <div class="controls">
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–ª–æ–∫–∞</h2>

            <label for="block-select">–í—ã–±–µ—Ä–∏—Ç–µ –±–ª–æ–∫ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:</label>

            <select id="block-select">
            </select>

            <button id="duplicate-block">–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –±–ª–æ–∫</button>
            <button id="delete-block">–£–¥–∞–ª–∏—Ç—å –±–ª–æ–∫</button>

            <label for="alignment-select">–í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞:</label>
            <select id="alignment-select">
                <option value="align-left">–í–ª–µ–≤–æ</option>
                <option value="align-center" selected>–ü–æ —Ü–µ–Ω—Ç—Ä—É</option>
                <option value="align-right">–í–ø—Ä–∞–≤–æ</option>
            </select>

            <label for="width-input">–®–∏—Ä–∏–Ω–∞ –±–ª–æ–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '80%' –∏–ª–∏ '600px'):</label>
            <input type="text" id="width-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 80% –∏–ª–∏ 600px">

            <label for="height-input">–í—ã—Å–æ—Ç–∞ –±–ª–æ–∫–∞ (–≤ –ø–∏–∫—Å–µ–ª—è—Ö, –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
            <input type="number" id="height-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 300" min="0">

            <label for="background-color-input">–¶–≤–µ—Ç —Ñ–æ–Ω–∞ –±–ª–æ–∫–∞:</label>
            <input type="color" id="background-color-input" value="#f0f0f0">

            <label for="site-background-color-input">–¶–≤–µ—Ç —Ñ–æ–Ω–∞ —Å–∞–π—Ç–∞:</label>
            <input type="color" id="site-background-color-input" value="#ffffff">

            <label for="image-file-input">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
            <input type="file" id="image-file-input" accept="image/*">
        </div>

        <hr>

        <div class="controls">
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–∫—Å—Ç–∞</h2>

            <label for="font-size-input">–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ —Ç–µ–∫—Å—Ç–∞ (–≤ –ø–∏–∫—Å–µ–ª—è—Ö):</label>
            <input type="number" id="font-size-input" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 16" min="1">

            <label for="text-color-input">–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞:</label>
            <input type="color" id="text-color-input" value="#000000">
            
            <label for="text-background-color-input">–¶–≤–µ—Ç —Ñ–æ–Ω–∞ —Ç–µ–∫—Å—Ç–∞:</label>
            <input type="color" id="text-background-color-input" value="#ffffff">

            <label for="text-alignment-select">–í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞:</label>
            <select id="text-alignment-select">
                <option value="left" selected>–í–ª–µ–≤–æ</option>
                <option value="center">–ü–æ —Ü–µ–Ω—Ç—Ä—É</option>
                <option value="right">–í–ø—Ä–∞–≤–æ</option>
                <option value="justify">–ü–æ —à–∏—Ä–∏–Ω–µ</option>
            </select>

            <label for="content-textarea">–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±–ª–æ–∫–∞:</label>
            <div id="content-editable" contenteditable="true" class="content-editable"></div>

            <div class="formatting-toolbar">
                <button type="button" data-command="bold"><strong>–ñ</strong></button>
                <button type="button" data-command="italic"><em>–ö</em></button>
                <button type="button" data-command="underline"><u>–ü</u></button>
                <button type="button" data-command="strikeThrough"><s>–ó</s></button>
                <button type="button" data-command="insertUnorderedList">‚Ä¢ –°–ø–∏—Å–æ–∫</button>
                <button type="button" data-command="insertOrderedList">1. –°–ø–∏—Å–æ–∫</button>

                <div class="link-buttons">
                    <button type="button" data-command="createLink">üîó –í—Å—Ç–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É</button>
                    <button type="button" data-command="unlink">‚ùå –£–±—Ä–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
                </div>
            </div>
        </div>

        <hr>

        <div class="controls">
            <button id="get-code">–°–∫–∞—á–∞—Ç—å —Å–∞–π—Ç</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
    const blockSelect = document.getElementById('block-select');
    const alignmentSelect = document.getElementById('alignment-select');
    const widthInput = document.getElementById('width-input');
    const heightInput = document.getElementById('height-input');
    const fontSizeInput = document.getElementById('font-size-input');
    const textColorInput = document.getElementById('text-color-input');
    const textBackgroundColorInput = document.getElementById('text-background-color-input'); // –ù–æ–≤–æ–µ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    const textAlignmentSelect = document.getElementById('text-alignment-select');
    const backgroundColorInput = document.getElementById('background-color-input');
    const imageFileInput = document.getElementById('image-file-input');
    const contentEditableDiv = document.getElementById('content-editable');
    const formattingToolbar = document.querySelector('.formatting-toolbar');
    const newBlockNameInput = document.getElementById('new-block-name');
    const addBlockButton = document.getElementById('add-block');
    const blocksContainer = document.getElementById('preview-container');
    const getCodeButton = document.getElementById('get-code');
    const duplicateBlockButton = document.getElementById('duplicate-block');
    const deleteBlockButton = document.getElementById('delete-block');
    const siteBackgroundColorInput = document.getElementById('site-background-color-input');

    // –û–±—ä–µ–∫—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–ª–æ–∫–æ–≤
    const blocks = new Map();
    const blockNames = [];
    let blockCount = 0; // –°—á–µ—Ç—á–∏–∫ –±–ª–æ–∫–æ–≤

    // –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
    window.addEventListener('beforeunload', function (event) {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
        event.preventDefault();
        event.returnValue = ''; // –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã —Ç—Ä–µ–±—É—é—Ç –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–æ–Ω–∞ —Å–∞–π—Ç–∞
    siteBackgroundColorInput.addEventListener('input', () => {
        blocksContainer.style.backgroundColor = siteBackgroundColorInput.value || '#ffffff';
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –±–ª–æ–∫–∞
    function addNewBlock(name, blockState = null) {
        blockCount++;
        const blockId = `block${blockCount}`;

        // –°–æ–∑–¥–∞—ë–º —ç–ª–µ–º–µ–Ω—Ç –±–ª–æ–∫–∞
        const blockElement = document.createElement('div');
        blockElement.id = blockId;
        blockElement.classList.add('block', 'align-center', 'draggable');
        blockElement.setAttribute('draggable', 'true');

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ –±–ª–æ–∫–∞
        blockElement.addEventListener('click', () => {
            blockSelect.value = blockId;
            blockSelect.dispatchEvent(new Event('change'));
        });

        // –°–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
        const contentContainer = document.createElement('div');
        contentContainer.classList.add('block-content');
        blockElement.appendChild(contentContainer);

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è drag-and-drop
        addDragAndDropHandlers(blockElement);

        // –î–æ–±–∞–≤–ª—è–µ–º –±–ª–æ–∫ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        blocksContainer.appendChild(blockElement);

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–ª–æ–∫–∞
        if (blockState) {
            blocks.set(blockId, {
                ...blockState,
                name,
            });
        } else {
            blocks.set(blockId, {
                name,
                alignment: 'align-center',
                width: '60%',
                height: '',
                fontSize: '16',
                textColor: '#000000',
                textBackgroundColor: '#ffffff', // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ —Ç–µ–∫—Å—Ç–∞
                textAlignment: 'left',
                backgroundColor: '#f0f0f0',
                imageDataUrl: '',
                content: ''
            });
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –±–ª–æ–∫ –≤ –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
        const option = document.createElement('option');
        option.value = blockId;
        option.textContent = name;
        blockSelect.appendChild(option);

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π –±–ª–æ–∫ –∫–∞–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–π
        blockSelect.value = blockId;
        blockSelect.dispatchEvent(new Event('change'));
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –±–ª–æ–∫–∞
    function updateBlock() {
        const selectedBlockId = blockSelect.value;
        const selectedBlock = document.getElementById(selectedBlockId);

        if (selectedBlock) {
            const blockState = blocks.get(selectedBlockId);

            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –±–ª–æ–∫–∞
            selectedBlock.classList.remove('align-left', 'align-center', 'align-right', 'full-width');
            selectedBlock.classList.add(alignmentSelect.value);

            // –ï—Å–ª–∏ —à–∏—Ä–∏–Ω–∞ 100%, –¥–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å full-width
            if (widthInput.value.trim() === '100%') {
                selectedBlock.classList.add('full-width');
            }

            blockState.alignment = alignmentSelect.value;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã
            const widthValue = widthInput.value.trim();
            const heightValue = heightInput.value.trim();

            selectedBlock.style.width = widthValue || '60%';
            blockState.width = widthValue || '60%';

            selectedBlock.style.height = heightValue ? `${heightValue}px` : 'auto';
            blockState.height = heightValue;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç —Ñ–æ–Ω–∞
            const backgroundColorValue = backgroundColorInput.value || '#f0f0f0';
            selectedBlock.style.backgroundColor = backgroundColorValue;
            blockState.backgroundColor = backgroundColorValue;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –±–ª–æ–∫–∞
            const contentContainer = selectedBlock.querySelector('.block-content');
            contentContainer.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            if (blockState.imageDataUrl) {
                const imgElement = document.createElement('img');
                imgElement.src = blockState.imageDataUrl;
                imgElement.alt = '';

                contentContainer.appendChild(imgElement);
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
            const textContentElement = document.createElement('div');
            textContentElement.classList.add('text-content');
            textContentElement.style.fontSize = `${blockState.fontSize}px`;
            textContentElement.style.color = blockState.textColor;
            textContentElement.style.backgroundColor = blockState.textBackgroundColor; // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ —Ç–µ–∫—Å—Ç–∞
            textContentElement.style.textAlign = blockState.textAlignment;
            textContentElement.innerHTML = blockState.content;

            contentContainer.appendChild(textContentElement);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –±–ª–æ–∫–∞
    function updateTextContent() {
        const selectedBlockId = blockSelect.value;
        const selectedBlock = document.getElementById(selectedBlockId);

        if (selectedBlock) {
            const blockState = blocks.get(selectedBlockId);

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä –∏ —Ü–≤–µ—Ç —à—Ä–∏—Ñ—Ç–∞
            const fontSizeValue = fontSizeInput.value.trim() || '16';
            blockState.fontSize = fontSizeValue;

            const textColorValue = textColorInput.value || '#000000';
            blockState.textColor = textColorValue;

            const textBackgroundColorValue = textBackgroundColorInput.value || '#ffffff';
            blockState.textBackgroundColor = textBackgroundColorValue;

            const textAlignmentValue = textAlignmentSelect.value || 'left';
            blockState.textAlignment = textAlignmentValue;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            const contentContainer = selectedBlock.querySelector('.block-content');
            contentContainer.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            if (blockState.imageDataUrl) {
                const imgElement = document.createElement('img');
                imgElement.src = blockState.imageDataUrl;
                imgElement.alt = '';
                contentContainer.appendChild(imgElement);
            }

            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
            const textContentElement = document.createElement('div');
            textContentElement.classList.add('text-content');
            textContentElement.style.fontSize = `${fontSizeValue}px`;
            textContentElement.style.color = textColorValue;
            textContentElement.style.backgroundColor = textBackgroundColorValue;
            textContentElement.style.textAlign = textAlignmentValue;
            textContentElement.innerHTML = contentEditableDiv.innerHTML;

            contentContainer.appendChild(textContentElement);

            blockState.content = contentEditableDiv.innerHTML;

            // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–π –æ–±–ª–∞—Å—Ç–∏
            contentEditableDiv.style.textAlign = textAlignmentValue;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    function updateImage() {
        const selectedBlockId = blockSelect.value;
        const selectedBlock = document.getElementById(selectedBlockId);
        const blockState = blocks.get(selectedBlockId);

        if (selectedBlock) {
            const file = imageFileInput.files[0];

            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const result = e.target.result;
                    if (typeof result === 'string') {
                        blockState.imageDataUrl = result;

                        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                        updateBlock();
                    } else {
                        console.error('FileReader result is not a string');
                    }
                };
                reader.readAsDataURL(file);
            } else {
                // –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ
                blockState.imageDataUrl = '';
                updateBlock();
            }
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –±–ª–æ–∫–∞
    function deleteBlock(blockId) {
        const blockElement = document.getElementById(blockId);
        if (blockElement) {
            const blockName = blocks.get(blockId).name;
            const nameIndex = blockNames.indexOf(blockName);
            if (nameIndex !== -1) {
                blockNames.splice(nameIndex, 1);
            }

            blocksContainer.removeChild(blockElement);
            blocks.delete(blockId);


            const option = blockSelect.querySelector(`option[value='${blockId}']`);
            if (option) {
                blockSelect.removeChild(option);
            }

            // –ï—Å–ª–∏ —É–¥–∞–ª–µ–Ω–Ω—ã–π –±–ª–æ–∫ –±—ã–ª –≤—ã–±—Ä–∞–Ω–Ω—ã–º, –≤—ã–±–∏—Ä–∞–µ–º –¥—Ä—É–≥–æ–π
            if (blockSelect.value === blockId) {
                if (blockSelect.options.length > 0) {
                    blockSelect.value = blockSelect.options[0].value;
                    blockSelect.dispatchEvent(new Event('change'));
                } else {
                    // –ù–µ—Ç –±–ª–æ–∫–æ–≤, –æ—á–∏—â–∞–µ–º –ø–æ–ª—è
                    contentEditableDiv.innerHTML = '';
                }
            }
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –±–ª–æ–∫–∞
    function duplicateBlock() {
        const selectedBlockId = blockSelect.value;
        const blockState = blocks.get(selectedBlockId);
        if (blockState) {
            const newName = blockState.name + ' (–∫–æ–ø–∏—è)';
            // –°–æ–∑–¥–∞–µ–º –≥–ª—É–±–æ–∫—É—é –∫–æ–ø–∏—é —Å–æ—Å—Ç–æ—è–Ω–∏—è –±–ª–æ–∫–∞
            const newBlockState = JSON.parse(JSON.stringify(blockState));
            addNewBlock(newName, newBlockState);
        }
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è drag-and-drop
    function addDragAndDropHandlers(element) {
        element.addEventListener('dragstart', handleDragStart);
        element.addEventListener('dragover', handleDragOver);
        element.addEventListener('dragenter', handleDragEnter);
        element.addEventListener('dragleave', handleDragLeave);
        element.addEventListener('drop', handleDrop);
        element.addEventListener('dragend', handleDragEnd);
    }

    let draggedElement = null;

    function handleDragStart(e) {
        this.style.opacity = '0.4';
        draggedElement = this;
        e.dataTransfer.effectAllowed = 'move';

        // –í—ã–±–∏—Ä–∞–µ–º –±–ª–æ–∫, –∫–æ—Ç–æ—Ä—ã–π –Ω–∞—á–∞–ª–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞—Ç—å
        blockSelect.value = this.id;
        blockSelect.dispatchEvent(new Event('change'));
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        return false;
    }

    function handleDragEnter() {
        this.classList.add('drag-over');
    }

    function handleDragLeave() {
        this.classList.remove('drag-over');
    }

    function handleDrop(e) {
        e.stopPropagation();
        this.classList.remove('drag-over');

        if (draggedElement !== this) {
            blocksContainer.insertBefore(draggedElement, this);
        }
        return false;
    }

    function handleDragEnd() {
        this.style.opacity = '1';
        blocksContainer.querySelectorAll('.block').forEach(block => {
            block.classList.remove('drag-over');
        });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫"
    addBlockButton.addEventListener('click', () => {
        const name = newBlockNameInput.value.trim();
        if (name === '') {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –±–ª–æ–∫–∞.');
            return;
        }
        if (blockNames.includes(name)) {
            alert('–ë–ª–æ–∫ —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. –í–≤–µ–¥–∏—Ç–µ –¥—Ä—É–≥–æ–µ –∏–º—è.');
            return;
        }
        addNewBlock(name);
        blockNames.push(name);
        newBlockNameInput.value = '';
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –±–ª–æ–∫–∞
    blockSelect.addEventListener('change', () => {
        const selectedBlockId = blockSelect.value;
        const blockState = blocks.get(selectedBlockId);

        if (blockState) {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            alignmentSelect.value = blockState.alignment;
            widthInput.value = blockState.width;
            heightInput.value = blockState.height;
            fontSizeInput.value = blockState.fontSize;
            textColorInput.value = blockState.textColor;
            textBackgroundColorInput.value = blockState.textBackgroundColor || '#ffffff'; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ —Ç–µ–∫—Å—Ç–∞
            textAlignmentSelect.value = blockState.textAlignment;
            backgroundColorInput.value = blockState.backgroundColor;
            contentEditableDiv.innerHTML = blockState.content;

            // –°–±—Ä–æ—Å –ø–æ–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
            imageFileInput.value = '';

            // –û–±–Ω–æ–≤–ª—è–µ–º –±–ª–æ–∫ –∏ —Ç–µ–∫—Å—Ç
            updateBlock();
            updateTextContent();
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–ª–æ–∫–∞
    alignmentSelect.addEventListener('change', updateBlock);
    widthInput.addEventListener('input', updateBlock);
    heightInput.addEventListener('input', updateBlock);
    backgroundColorInput.addEventListener('input', updateBlock);
    imageFileInput.addEventListener('change', updateImage);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ç–µ–∫—Å—Ç–∞
    fontSizeInput.addEventListener('input', updateTextContent);
    textColorInput.addEventListener('input', updateTextContent);
    textBackgroundColorInput.addEventListener('input', updateTextContent); // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ü–≤–µ—Ç–∞ —Ñ–æ–Ω–∞ —Ç–µ–∫—Å—Ç–∞
    textAlignmentSelect.addEventListener('change', updateTextContent);
    contentEditableDiv.addEventListener('input', updateTextContent);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    formattingToolbar.addEventListener('click', (e) => {
        const button = e.target.closest('button[data-command]');
        if (button) {
            e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

            const command = button.getAttribute('data-command');

            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ contentEditableDiv
            contentEditableDiv.focus();

            if (command === 'createLink') {
                let url = prompt('–í–≤–µ–¥–∏—Ç–µ URL —Å—Å—ã–ª–∫–∏:', 'https://');
                if (url) {
                    let selection = window.getSelection();
                    if (selection.rangeCount > 0 && !selection.isCollapsed) {
                        document.execCommand('createLink', false, url);
                    } else {
                        let linkText = prompt('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å—Å—ã–ª–∫–∏:', '–°—Å—ã–ª–∫–∞');
                        if (linkText) {
                            document.execCommand('insertHTML', false, '<a href="' + url + '">' + linkText + '</a>');
                        }
                    }
                }
            } else if (command === 'unlink') {
                document.execCommand('unlink', false, null);
            } else {
                // –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—É —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                document.execCommand(command, false, null);
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            updateTextContent();
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –±–ª–æ–∫" –∏ "–£–¥–∞–ª–∏—Ç—å –±–ª–æ–∫"
    duplicateBlockButton.addEventListener('click', duplicateBlock);
    deleteBlockButton.addEventListener('click', () => {
        const selectedBlockId = blockSelect.value;
        deleteBlock(selectedBlockId);
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–¥–∞ —Å–∞–π—Ç–∞ –∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
    function getSiteCode() {
        // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å –Ω–∞—á–∞–ª–æ–º HTML-–¥–æ–∫—É–º–µ–Ω—Ç–∞
        let html = '<!DOCTYPE html>\n<html>\n<head>\n';

        // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫
        html += '<meta charset="UTF-8">\n';
        html += '<title>–ú–æ–π —Å–∞–π—Ç</title>\n';

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∏–≥—É—Ä–Ω—ã–µ —Å–∫–æ–±–∫–∏ –≤ href
        html += '<link type="text/css" rel="stylesheet" href="/media/Usersite/&#123;&#123;directory&#125;&#125;/styles.css">\n';

        // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–µ–≥ head –∏ –Ω–∞—á–∏–Ω–∞–µ–º body
        html += '</head>\n<body';

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ —Å–∞–π—Ç–∞
        const siteBackgroundColor = siteBackgroundColorInput.value || '#ffffff';
        html += ` style="background-color: ${siteBackgroundColor};">\n`;

        // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –±–ª–æ–∫–∞–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö –≤ HTML
        blocksContainer.querySelectorAll('.block').forEach(blockElement => {
            // –ö–ª–æ–Ω–∏—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏ —É–¥–∞–ª—è–µ–º –Ω–µ–Ω—É–∂–Ω—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã
            const newBlockElement = blockElement.cloneNode(true);
            newBlockElement.removeAttribute('draggable');
            newBlockElement.classList.remove('draggable');

            // –î–æ–±–∞–≤–ª—è–µ–º –≤–Ω–µ—à–Ω–∏–π HTML –±–ª–æ–∫–∞ –≤ –Ω–∞—à—É —Å—Ç—Ä–æ–∫—É
            html += newBlockElement.outerHTML + '\n';
        });

        // –ó–∞–∫—Ä—ã–≤–∞–µ–º body –∏ html
        html += '</body>\n</html>';

        // –°–æ–∑–¥–∞–µ–º Blob –∏–∑ —Å—Ç—Ä–æ–∫–∏ —Å –∫–æ–¥–æ–º –¥–ª—è index.html
        const htmlBlob = new Blob([html], { type: 'text/html' });

        // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è styles.css
        const cssContent = `
            body {
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 0;
                background-color: ${siteBackgroundColor};
            }
            .block {
                width: 60%;
                padding: 20px;
                margin: 10px auto;
                background-color: #f0f0f0;
                border: 1px solid #ccc;
                box-sizing: border-box;
            }
            .block.full-width {
                width: 100%;
                margin: 0;
            }
            .block.align-left {
                margin-left: 0;
                margin-right: auto;
            }
            .block.align-center {
                margin-left: auto;
                margin-right: auto;
            }
            .block.align-right {
                margin-left: auto;
                margin-right: 0;
            }
            .block img {
                max-width: 100%;
                height: auto;
                display: block;
                margin: 10px 0;
            }
            .text-content {
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
        `;

        // –°–æ–∑–¥–∞–µ–º Blob –¥–ª—è styles.css
        const cssBlob = new Blob([cssContent], { type: 'text/css' });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
        function downloadBlob(blob, filename) {
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // –°–∫–∞—á–∏–≤–∞–µ–º index.html
        downloadBlob(htmlBlob, 'index.html');

        // –°–∫–∞—á–∏–≤–∞–µ–º styles.css
        downloadBlob(cssBlob, 'styles.css');
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–°–∫–∞—á–∞—Ç—å —Å–∞–π—Ç"
    getCodeButton.addEventListener('click', getSiteCode);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–ª–æ–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    addNewBlock('–ó–∞–≥–æ–ª–æ–≤–æ–∫');
});
</script>
{% endblock content %}
